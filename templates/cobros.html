{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="m-0">üßæ Plan de cobro</h2>
  <a class="btn btn-secondary btn-sm" href="/dashboard">‚¨Ö Volver</a>
</div>

{% if total_alertas and total_alertas > 0 %}
  <div class="alert alert-warning">
    ‚ö†Ô∏è <b>{{ total_alertas }}</b> cliente(s) sin pago en el per√≠odo (hoy/semana) y con saldo pendiente.
    <br><small>Tip: escribe el valor y presiona <b>Enter</b> para registrar.</small>
  </div>
{% else %}
  <div class="alert alert-success">
    ‚úÖ Todos los clientes tienen pago en el per√≠odo o no tienen saldo pendiente.
  </div>
{% endif %}

<div class="alert alert-info">
  <b>Hoy:</b> {{ today }} |
  <b>Semana (desde lunes):</b> {{ week_start }} ‚Üí {{ today }} <br>
  <small>
    Regla actual: <b>diario</b> = pr√©stamo / 30 d√≠as, <b>semanal</b> = pr√©stamo / 12 semanas.
  </small>
</div>

<div class="card p-3">
  <table class="table table-bordered bg-white m-0">
    <thead>
      <tr>
        <th>Estado</th>
        <th>Cliente</th>
        <th>C√©dula</th>
        <th>Tipo</th>
        <th>Cuota sugerida</th>
        <th>Pagado hoy</th>
        <th>Pagado semana</th>
        <th>Debe (hoy/semana)</th>
        <th>Saldo total</th>
        <th style="width:420px;">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% if filas|length == 0 %}
        <tr><td colspan="10" class="text-center">No hay clientes</td></tr>
      {% endif %}

      {% set ns = namespace(focus_set=false) %}

      {% for r in filas %}
      <tr
        {% if r["alerta"] %}style="background:#fff3cd;"
        {% elif r["omitido_hoy"] %}style="background:#eef2f7; opacity:0.85;"
        {% endif %}
      >
        <td>
          {% if r["saldo"]|float <= 0 %}
            ‚úÖ Al d√≠a
          {% else %}
            {% if r["omitido_hoy"] %}
              üí§ No cobrar hoy
            {% else %}
              {% if r["alerta"] %}
                ‚ö†Ô∏è Sin pago
              {% else %}
                ‚úÖ Pag√≥
              {% endif %}
            {% endif %}
          {% endif %}
        </td>

        <td>{{ r["nombre"] }}</td>
        <td>{{ r["cedula"] }}</td>
        <td><b>{{ r["tipo_cobro"] }}</b></td>

        <td>$ {{ "{:,.0f}".format(r["cuota_sugerida"]|float).replace(",", ".") }}</td>
        <td>$ {{ "{:,.0f}".format(r["pagado_hoy"]|float).replace(",", ".") }}</td>
        <td>$ {{ "{:,.0f}".format(r["pagado_semana"]|float).replace(",", ".") }}</td>

        <td><b>$ {{ "{:,.0f}".format(r["debe"]|float).replace(",", ".") }}</b></td>

        <td>$ {{ "{:,.0f}".format(r["saldo"]|float).replace(",", ".") }}</td>

        <td>
          {% if r["saldo"]|float > 0 %}

            {% if not r["omitido_hoy"] %}
              <!-- ‚úÖ PAGO R√ÅPIDO -->
              <form method="post" action="/cobros/pago_rapido" class="d-flex gap-2 mb-2 pago-rapido-form"
                    onsubmit="return confirm('¬øRegistrar este pago r√°pido con fecha de HOY?');">
                <input type="hidden" name="cedula" value="{{ r['cedula'] }}">

                <input
                  type="number"
                  name="valor"
                  class="form-control form-control-sm pago-rapido-input"
                  required
                  min="0"
                  step="0.01"
                  max="{{ r['saldo']|float }}"
                  value="{{ r['valor_sugerido']|float }}"
                  style="width:150px;"
                  onfocus="this.select()"
                  title="No puede ser mayor al saldo"
                  {% if (not ns.focus_set) and r["alerta"] %}
                    autofocus
                    data-autofocus="1"
                    {% set ns.focus_set = true %}
                  {% endif %}
                >

                <button class="btn btn-success btn-sm" style="min-width:160px;">Pago r√°pido (hoy)</button>
              </form>

              <!-- ‚úÖ NO COBRAR HOY -->
              <form method="post" action="/cobros/no_cobrar_hoy" class="mb-2"
                    onsubmit="return confirm('¬øMarcar este cliente como NO COBRAR HOY?');">
                <input type="hidden" name="cedula" value="{{ r['cedula'] }}">
                <button class="btn btn-outline-secondary btn-sm w-100">üí§ No cobrar hoy</button>
              </form>
            {% else %}
              <!-- ‚úÖ DESHACER -->
              <form method="post" action="/cobros/deshacer_no_cobrar_hoy" class="mb-2"
                    onsubmit="return confirm('¬øDeshacer NO COBRAR HOY para este cliente?');">
                <input type="hidden" name="cedula" value="{{ r['cedula'] }}">
                <button class="btn btn-warning btn-sm w-100">‚Ü©Ô∏è Deshacer (cobrar hoy)</button>
              </form>
            {% endif %}

          {% endif %}

          <a class="btn btn-outline-success btn-sm w-100 mb-1" href="/pagos?cedula={{ r['cedula'] }}">Registrar pago</a>
          <a class="btn btn-info btn-sm w-100" href="/clientes/ver?cedula={{ r['cedula'] }}">Ver cliente</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  window.addEventListener("load", function () {
    const el = document.querySelector('[data-autofocus="1"]');
    if (el) {
      el.focus();
      el.select();
    }
  });

  document.addEventListener("keydown", function (e) {
    const target = e.target;
    if (!target) return;

    if (e.key === "Enter" && target.classList.contains("pago-rapido-input")) {
      e.preventDefault();
      const form = target.closest("form");
      if (form) form.requestSubmit();
    }
  });
</script>

{% endblock %}
